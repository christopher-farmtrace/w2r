<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SA ID Barcode Autofill (2-step + enums + flat payload)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 14px; }
    label { display:block; font-size: 12px; opacity:.8; margin: 10px 0 4px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #333; background: #111; color: white; font-size: 16px; }
    button.secondary { background: white; color: #111; }
    .hint { font-size: 13px; opacity: .8; line-height: 1.4; }
    .ok { color: #0a7; font-weight: 600; }
    .bad { color: #c22; font-weight: 600; }
    .stepper { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; }
    .pill.active { border-color:#111; background:#111; color:#fff; }
    #scanCapture { position: fixed; left: -9999px; top: -9999px; opacity: 0; height: 1px; width: 1px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin: 0; }
    .footer-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .hidden { display:none !important; }
    .muted { opacity:.75; }
  </style>
</head>
<body>

  <div class="card">
    <div class="stepper" style="margin-bottom:10px;">
      <span class="pill active" id="pill1">Step 1: Scan ID</span>
      <span class="pill" id="pill2">Step 2: Extra details</span>
    </div>

    <h2 style="margin:0 0 8px;">Barcode → Form Autofill</h2>
    <div class="hint">
      Tap <b>Start scanning</b>, then scan the SA ID barcode. Most phone barcode scanners act like a keyboard and “type”
      the decoded text quickly, ending with Enter/Tab. This page captures it and fills the fields.
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="startBtn" type="button">Start scanning</button>
      <button id="clearBtn" class="secondary" type="button">Clear</button>
    </div>

    <div style="margin-top:10px;" id="status"></div>

    <textarea id="scanCapture" autocomplete="off" autocapitalize="off" spellcheck="false"></textarea>
  </div>

  <!-- STEP 1 -->
  <div class="card" id="step1">
    <h3 style="margin:0 0 8px;">Step 1: Staff Details (autofill)</h3>

    <label>Surname</label>
    <input id="surname" />

    <label>Names</label>
    <input id="names" />

    <div class="row">
      <div>
        <label>Gender</label>
        <select id="gender">
          <option value=""></option>
          <option value="M">M</option>
          <option value="F">F</option>
        </select>
      </div>
      <div>
        <label>ID Number</label>
        <input id="idNumber" inputmode="numeric" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Date of Birth</label>
        <input id="dob" placeholder="YYYY-MM-DD" />
      </div>
      <div>
        <label>Citizenship</label>
        <input id="citizenship" placeholder="CITIZEN / PERMANENT RESIDENT / ..." />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Nationality (scanned)</label>
        <input id="nationality" placeholder="SA / RSA / ..." />
      </div>
      <div>
        <label>Issue Date</label>
        <input id="issueDate" placeholder="YYYY-MM-DD" />
      </div>
    </div>

    <div class="footer-actions">
      <button id="nextStepBtn" type="button">Next step</button>
    </div>
    <div class="hint muted" style="margin-top:8px;">
      Tip: if scanning is unreliable, check the Debug section to see what your scanner app outputs.
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card hidden" id="step2">
    <h3 style="margin:0 0 8px;">Step 2: Extra details (manual)</h3>

    <div class="row">
      <div>
        <label>Race</label>
        <select id="race">
          <option value=""></option>
          <option value="African">African</option>
          <option value="Asian">Asian</option>
          <option value="Coloured">Coloured</option>
          <option value="Indian">Indian</option>
          <option value="White">White</option>
        </select>
      </div>
      <div>
        <label>Language</label>
        <select id="language">
          <option value=""></option>
          <option value="Afrikaans">Afrikaans</option>
          <option value="English">English</option>
          <option value="Ndelebele">Ndelebele</option>
          <option value="Other">Other</option>
          <option value="Sepedi">Sepedi</option>
          <option value="Siswati">Siswati</option>
        </select>
      </div>
    </div>

    <label>Marital Status</label>
    <select id="maritalStatus">
      <option value=""></option>
      <option value="Single">Single</option>
      <option value="Married">Married</option>
    </select>

    <h4 style="margin:14px 0 6px;">Address details</h4>

    <label>Country</label>
    <input id="addrCountry" placeholder="e.g. South Africa" />

    <div class="row">
      <div>
        <label>Street Number</label>
        <input id="streetNumber" inputmode="numeric" />
      </div>
      <div>
        <label>Street Name</label>
        <input id="streetName" />
      </div>
    </div>

    <label>Suburb</label>
    <input id="suburb" />

    <div class="row">
      <div>
        <label>City/Town</label>
        <input id="cityTown" />
      </div>
      <div>
        <label>Province</label>
        <input id="province" />
      </div>
    </div>

    <label>Postal Code</label>
    <input id="postalCode" inputmode="numeric" />

    <div class="footer-actions">
      <button id="backBtn" class="secondary" type="button">Back</button>
      <button id="submitBtn" type="button">Submit</button>
    </div>

    <div class="hint muted" style="margin-top:8px;">
      Submit will output the JSON payload into the Debug panel (no network request yet).
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">Debug</h3>
    <div class="hint">Raw scan, parsed fields, and (on Submit) the final payload.</div>

    <label>Raw scan</label>
    <pre id="rawOut"></pre>

    <label style="margin-top:10px;">Fields detected</label>
    <pre id="fieldsOut"></pre>

    <label style="margin-top:10px;">Submit payload</label>
    <pre id="payloadOut">(submit to view payload)</pre>
  </div>

<script>
(function () {
  const scanCapture = document.getElementById('scanCapture');
  const startBtn = document.getElementById('startBtn');
  const clearBtn = document.getElementById('clearBtn');
  const status = document.getElementById('status');

  const rawOut = document.getElementById('rawOut');
  const fieldsOut = document.getElementById('fieldsOut');
  const payloadOut = document.getElementById('payloadOut');

  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const nextStepBtn = document.getElementById('nextStepBtn');
  const backBtn = document.getElementById('backBtn');
  const submitBtn = document.getElementById('submitBtn');

  const pill1 = document.getElementById('pill1');
  const pill2 = document.getElementById('pill2');

  const $ = (id) => document.getElementById(id);

  let buffer = "";
  let flushTimer = null;

  function setStatus(msg, ok=true) {
    status.innerHTML = `<span class="${ok ? 'ok' : 'bad'}">${msg}</span>`;
  }

  function setStep(n) {
    if (n === 1) {
      step1.classList.remove("hidden");
      step2.classList.add("hidden");
      pill1.classList.add("active");
      pill2.classList.remove("active");
    } else {
      step1.classList.add("hidden");
      step2.classList.remove("hidden");
      pill1.classList.remove("active");
      pill2.classList.add("active");
      scanCapture.blur(); // avoid accidental scan characters while typing address
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function clearAll() {
    buffer = "";
    scanCapture.value = "";
    rawOut.textContent = "";
    fieldsOut.textContent = "";
    payloadOut.textContent = "(submit to view payload)";

    const ids = [
      "surname","names","gender","idNumber","dob","citizenship","nationality","issueDate",
      "race","language","maritalStatus",
      "addrCountry","streetNumber","streetName","suburb","cityTown","province","postalCode"
    ];
    ids.forEach(id => {
      const el = $(id);
      if (!el) return;
      el.value = "";
    });

    setStatus("Cleared.", true);
    setStep(1);
  }

  function normalizeWhitespace(s) {
    return s.replace(/\r/g, "\n").replace(/\t/g, "\n").replace(/[ ]{2,}/g, " ").trim();
  }

  function splitFields(s) {
    if (/\n/.test(s)) return s.split("\n").map(p => p.trim()).filter(Boolean);
    if (s.includes("|")) return s.split("|").map(p => p.trim()).filter(Boolean);
    return s.split(/\s*\|\s*|\s{2,}/).map(p => p.trim()).filter(Boolean);
  }

  function parseSaIdFields(parts) {
    const idMatchIndex = parts.findIndex(p => /^\d{13}$/.test(p.replace(/\s/g,'')));
    const idNumber = idMatchIndex >= 0 ? parts[idMatchIndex].replace(/\s/g,'') : "";

    // Default positional mapping (common case)
    let surname = parts[0] || "";
    let names = parts[1] || "";
    let gender = "";
    let nationality = parts[3] || "";   // was countryScanned, now nationality
    let dobRaw = parts[5] || "";
    let citizenship = parts[7] || "";
    let issueRaw = parts[8] || "";

    function looksLikeGender(v) { return /^M$|^F$/i.test((v||"").trim()); }
    function looksLikeDateWords(v) { return /^\d{2}\s+[A-Z]{3}\s+\d{4}$/i.test((v||"").trim()); }
    function parseDateWords(v) {
      const m = (v||"").trim().toUpperCase().match(/^(\d{2})\s+([A-Z]{3})\s+(\d{4})$/);
      if (!m) return "";
      const dd = m[1], mon = m[2], yyyy = m[3];
      const map = {JAN:"01",FEB:"02",MAR:"03",APR:"04",MAY:"05",JUN:"06",JUL:"07",AUG:"08",SEP:"09",OCT:"10",NOV:"11",DEC:"12"};
      const mm = map[mon] || "";
      return mm ? `${yyyy}-${mm}-${dd}` : "";
    }

    if (looksLikeGender(parts[2])) gender = parts[2].toUpperCase();

    // Re-anchor around the ID number if present (handles slightly different layouts)
    if (idMatchIndex >= 0) {
      if ((!nationality || nationality.length > 10) && parts[idMatchIndex - 1]) nationality = parts[idMatchIndex - 1];
      if (!dobRaw && parts[idMatchIndex + 1]) dobRaw = parts[idMatchIndex + 1];
      if (!citizenship && parts[idMatchIndex + 3]) citizenship = parts[idMatchIndex + 3];
      if (!issueRaw && parts[idMatchIndex + 4]) issueRaw = parts[idMatchIndex + 4];

      if (!gender) {
        const g = parts.find(looksLikeGender);
        if (g) gender = g.toUpperCase();
      }
    }

    const dob = looksLikeDateWords(dobRaw) ? parseDateWords(dobRaw) : "";
    const issueDate = looksLikeDateWords(issueRaw) ? parseDateWords(issueRaw) : "";

    return { surname, names, gender, nationality, idNumber, dob, citizenship, issueDate };
  }

  function fillStep1(data) {
    if (data.surname) $("surname").value = data.surname;
    if (data.names) $("names").value = data.names;
    if (data.gender) $("gender").value = data.gender;
    if (data.nationality) $("nationality").value = data.nationality;
    if (data.idNumber) $("idNumber").value = data.idNumber;
    if (data.dob) $("dob").value = data.dob;
    if (data.citizenship) $("citizenship").value = data.citizenship;
    if (data.issueDate) $("issueDate").value = data.issueDate;
  }

  function parseAndApply(raw) {
    const normalized = normalizeWhitespace(raw);
    rawOut.textContent = normalized || "(empty)";

    const parts = splitFields(normalized);
    fieldsOut.textContent = parts.map((p, i) => `[${i}] ${p}`).join("\n") || "(no fields detected)";

    const data = parseSaIdFields(parts);
    fillStep1(data);

    if (data.idNumber) setStatus("Scan captured and Step 1 autofilled", true);
    else setStatus("Scan captured, but no 13-digit ID detected. Check Debug output.", false);
  }

  function scheduleFlush() {
    if (flushTimer) clearTimeout(flushTimer);
    flushTimer = setTimeout(() => {
      if (buffer.trim().length > 0) {
        parseAndApply(buffer);
        buffer = "";
        scanCapture.value = "";
      }
    }, 120);
  }

  // Capture keyboard wedge scan
  scanCapture.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === "Tab") {
      e.preventDefault();
      const v = scanCapture.value;
      const raw = (buffer + (v ? "\n" + v : "")).trim();
      if (raw) parseAndApply(raw);
      buffer = "";
      scanCapture.value = "";
      return;
    }
    scheduleFlush();
  });

  scanCapture.addEventListener("input", () => {
    buffer = scanCapture.value;
    scheduleFlush();
  });

  // Buttons
  startBtn.addEventListener("click", () => {
    scanCapture.focus({ preventScroll: true });
    setStatus("Ready. Now scan the barcode…", true);
  });

  clearBtn.addEventListener("click", clearAll);

  nextStepBtn.addEventListener("click", () => setStep(2));
  backBtn.addEventListener("click", () => setStep(1));

  // Submit: output FLAT payload to Debug panel
  submitBtn.addEventListener("click", () => {
    const payload = {
      surname: $("surname").value.trim() || null,
      names: $("names").value.trim() || null,
      gender: $("gender").value || null,
      idNumber: $("idNumber").value.trim() || null,
      dob: $("dob").value.trim() || null,
      citizenship: $("citizenship").value.trim() || null,
      nationality: $("nationality").value.trim() || null, // renamed from countryScanned
      issueDate: $("issueDate").value.trim() || null,

      race: $("race").value || null,
      language: $("language").value || null,
      maritalStatus: $("maritalStatus").value || null,

      country: $("addrCountry").value.trim() || null,
      streetNumber: $("streetNumber").value.trim() || null,
      streetName: $("streetName").value.trim() || null,
      suburb: $("suburb").value.trim() || null,
      cityTown: $("cityTown").value.trim() || null,
      province: $("province").value.trim() || null,
      postalCode: $("postalCode").value.trim() || null
    };

    payloadOut.textContent = JSON.stringify(payload, null, 2);
    setStatus("Submitted (payload written to Debug panel)", true);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  window.addEventListener("load", () => {
    setStatus("Tap “Start scanning” to focus the scan field.", true);
  });

})();
</script>

</body>
</html>