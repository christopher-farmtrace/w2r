<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SA ID Barcode Autofill</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: #f5f5f5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 14px; background: #fff; }
    label { display:block; font-size: 12px; opacity:.8; margin: 10px 0 4px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #333; background: #111; color: white; font-size: 16px; cursor: pointer; }
    button.secondary { background: white; color: #111; }
    button:disabled { opacity: .4; cursor: not-allowed; }
    .hint { font-size: 13px; opacity: .8; line-height: 1.4; }
    .ok { color: #0a7; font-weight: 600; }
    .bad { color: #c22; font-weight: 600; }
    .warn { color: #b85c00; font-weight: 600; }
    .stepper { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; }
    .pill.active { border-color:#111; background:#111; color:#fff; }
    #scanCapture { position: fixed; left: -9999px; top: -9999px; opacity: 0; height: 1px; width: 1px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin: 0; }
    .footer-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .hidden { display:none !important; }
    .muted { opacity:.75; }
    #placesStatus { font-size: 12px; margin-top: 4px; min-height: 18px; }
    .pac-container { z-index: 9999; }

    /* â”€â”€ Camera button â”€â”€ */
    #cameraBtn {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0057d8; border-color: #0046b0;
    }
    #cameraBtn svg { flex-shrink: 0; }
    #cameraBtn:disabled { background: #666; border-color: #555; }

    /* â”€â”€ Fullscreen scanner overlay â”€â”€ */
    #scanOverlay {
      position: fixed; inset: 0; z-index: 1000;
      background: #000;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    #scanOverlay.hidden { display: none !important; }

    #cameraFeed {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    /* Viewfinder â€” PDF417 is wide so use 3:1 ratio */
    .scan-frame {
      position: relative; z-index: 2;
      width: min(88vw, 520px);
      aspect-ratio: 3 / 1;
      border-radius: 10px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      border: 2.5px solid rgba(255,255,255,0.8);
      overflow: hidden;
    }

    .scan-line {
      position: absolute; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent 0%, #38f 30%, #8cf 50%, #38f 70%, transparent 100%);
      animation: scanMove 1.8s ease-in-out infinite;
    }
    @keyframes scanMove {
      0%   { top: 2%;  opacity:1; }
      45%  { top: 92%; opacity:1; }
      50%  { top: 92%; opacity:0; }
      55%  { top: 2%;  opacity:0; }
      60%  { top: 2%;  opacity:1; }
      100% { top: 2%;  opacity:1; }
    }

    /* Corner accents */
    .scan-frame::before, .scan-frame::after,
    .scan-corner-br, .scan-corner-bl {
      content: ''; position: absolute;
      width: 18px; height: 18px;
      border-color: #4af; border-style: solid;
    }
    .scan-frame::before { top:-1px; left:-1px;   border-width:3px 0 0 3px; border-radius:6px 0 0 0; }
    .scan-frame::after  { top:-1px; right:-1px;  border-width:3px 3px 0 0; border-radius:0 6px 0 0; }
    .scan-corner-br     { bottom:-1px; right:-1px; border-width:0 3px 3px 0; border-radius:0 0 6px 0; }
    .scan-corner-bl     { bottom:-1px; left:-1px;  border-width:0 0 3px 3px; border-radius:0 0 0 6px; }

    .scan-label {
      position: relative; z-index: 2;
      color: rgba(255,255,255,0.9);
      font-size: 13px; text-align: center;
      margin-top: 18px; padding: 0 24px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.8);
    }

    #scanMsg {
      position: relative; z-index: 2;
      font-size: 13px; font-weight: 600;
      text-align: center;
      margin-top: 10px; padding: 7px 20px;
      border-radius: 999px;
      background: rgba(0,0,0,0.5);
      color: #fff; min-height: 32px;
      transition: background 0.2s;
    }
    #scanMsg.ok-msg  { background: rgba(0,148,80,0.8); }
    #scanMsg.bad-msg { background: rgba(190,30,30,0.8); }

    .scan-actions {
      position: relative; z-index: 2;
      display: flex; gap: 12px; margin-top: 18px;
    }
    .scan-actions button { padding: 11px 22px; font-size: 15px; border-radius: 12px; }
    #closeScanBtn { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.3); color: #fff; }
    #torchBtn     { background: rgba(255,200,0,0.16);  border-color: rgba(255,200,0,0.4);  color: #ffe; }
    #torchBtn.lit { background: rgba(255,200,0,0.55); }

    @keyframes successFlash {
      0%   { background: rgba(0,220,100,0.0); }
      20%  { background: rgba(0,220,100,0.5); }
      100% { background: rgba(0,220,100,0.0); }
    }
    .flash-layer {
      position: absolute; inset: 0; z-index: 3; pointer-events: none;
      animation: successFlash 0.65s ease-out forwards;
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CAMERA OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scanOverlay" class="hidden" role="dialog" aria-modal="true" aria-label="Barcode Scanner">
  <video id="cameraFeed" playsinline muted autoplay></video>
  <div class="scan-frame" id="scanFrame">
    <div class="scan-line"></div>
    <div class="scan-corner-br"></div>
    <div class="scan-corner-bl"></div>
  </div>
  <div class="scan-label">Hold the PDF417 barcode (back of SA ID) inside the frame</div>
  <div id="scanMsg">Initialisingâ€¦</div>
  <div class="scan-actions">
    <button id="torchBtn" type="button">ğŸ”¦ Torch</button>
    <button id="closeScanBtn" type="button">âœ• Cancel</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card">
  <div class="stepper" style="margin-bottom:10px;">
    <span class="pill active" id="pill1">Step 1: Scan ID</span>
    <span class="pill" id="pill2">Step 2: Extra details</span>
  </div>

  <h2 style="margin:0 0 8px;">Barcode â†’ Form Autofill</h2>
  <div class="hint">
    Tap <b>Scan with Camera</b> to use your phone's camera on the PDF417 barcode on the
    <b>back</b> of the SA ID. Or use a Bluetooth / USB barcode scanner with <b>Keyboard scanner</b>.
  </div>

  <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="cameraBtn" type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      Scan with Camera
    </button>
    <button id="startBtn" class="secondary" type="button">âŒ¨ Keyboard scanner</button>
    <button id="clearBtn" class="secondary" type="button">Clear</button>
  </div>

  <div style="margin-top:10px;" id="status"></div>
  <textarea id="scanCapture" autocomplete="off" autocapitalize="off" spellcheck="false"></textarea>
</div>

<!-- STEP 1 -->
<div class="card" id="step1">
  <h3 style="margin:0 0 8px;">Step 1: Staff Details (autofill)</h3>

  <label>Surname</label>
  <input id="surname" />

  <label>Names</label>
  <input id="names" />

  <div class="row">
    <div>
      <label>Gender</label>
      <select id="gender">
        <option value=""></option>
        <option value="M">M</option>
        <option value="F">F</option>
      </select>
    </div>
    <div>
      <label>ID Number</label>
      <input id="idNumber" inputmode="numeric" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>Date of Birth</label>
      <input id="dob" placeholder="YYYY-MM-DD" />
    </div>
    <div>
      <label>Citizenship</label>
      <input id="citizenship" placeholder="CITIZEN / PERMANENT RESIDENT / ..." />
    </div>
  </div>

  <div class="row">
    <div>
      <label>Nationality (scanned)</label>
      <input id="nationality" placeholder="SA / RSA / ..." />
    </div>
    <div>
      <label>Issue Date</label>
      <input id="issueDate" placeholder="YYYY-MM-DD" />
    </div>
  </div>

  <div class="footer-actions">
    <button id="nextStepBtn" type="button">Next step â†’</button>
  </div>
  <div class="hint muted" style="margin-top:8px;">
    Tip: check the Debug section if scanning produces unexpected results.
  </div>
</div>

<!-- STEP 2 -->
<div class="card hidden" id="step2">
  <h3 style="margin:0 0 8px;">Step 2: Extra details (manual)</h3>

  <div class="row">
    <div>
      <label>Race</label>
      <select id="race">
        <option value=""></option>
        <option value="African">African</option>
        <option value="Asian">Asian</option>
        <option value="Coloured">Coloured</option>
        <option value="Indian">Indian</option>
        <option value="White">White</option>
      </select>
    </div>
    <div>
      <label>Language</label>
      <select id="language">
        <option value=""></option>
        <option value="Afrikaans">Afrikaans</option>
        <option value="English">English</option>
        <option value="Ndelebele">Ndelebele</option>
        <option value="Other">Other</option>
        <option value="Sepedi">Sepedi</option>
        <option value="Siswati">Siswati</option>
      </select>
    </div>
  </div>

  <label>Marital Status</label>
  <select id="maritalStatus">
    <option value=""></option>
    <option value="Single">Single</option>
    <option value="Married">Married</option>
  </select>

  <h4 style="margin:14px 0 6px;">Address details</h4>

  <label>Search address <span class="hint muted" style="display:inline;">(type to autocomplete)</span></label>
  <input id="placesSearch" placeholder="e.g. 12 Main Street, Sandton" autocomplete="off" />
  <div id="placesStatus"></div>

  <label>Country</label>
  <input id="addrCountry" placeholder="e.g. South Africa" />

  <div class="row">
    <div>
      <label>Street Number</label>
      <input id="streetNumber" inputmode="numeric" />
    </div>
    <div>
      <label>Street Name</label>
      <input id="streetName" />
    </div>
  </div>

  <label>Suburb</label>
  <input id="suburb" />

  <div class="row">
    <div>
      <label>City/Town</label>
      <input id="cityTown" />
    </div>
    <div>
      <label>Province</label>
      <input id="province" />
    </div>
  </div>

  <label>Postal Code</label>
  <input id="postalCode" inputmode="numeric" />

  <div class="footer-actions">
    <button id="backBtn" class="secondary" type="button">â† Back</button>
    <button id="submitBtn" type="button">Submit</button>
  </div>

  <div class="hint muted" style="margin-top:8px;">
    Submit will output the JSON payload into the Debug panel (no network request yet).
  </div>
</div>

<!-- SETTINGS -->
<div class="card" id="settingsCard">
  <details id="settingsDetails">
    <summary style="cursor:pointer; font-weight:600; font-size:15px; list-style:none; display:flex; align-items:center; gap:8px;">
      <span>âš™ Settings</span>
      <span id="apiKeyBadge" style="font-size:11px; padding:3px 8px; border-radius:999px; background:#eee; color:#555; font-weight:400;"></span>
    </summary>

    <div style="margin-top:12px;">
      <label style="font-weight:600;">Google Maps API Key</label>
      <div class="hint muted" style="margin-bottom:6px;">
        Stored in your browser's localStorage â€” never sent anywhere except Google's API.
        Get a key at <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">console.cloud.google.com</a>.
      </div>
      <div style="display:flex; gap:8px; align-items:stretch;">
        <input id="apiKeyInput" type="password" placeholder="AIzaâ€¦" autocomplete="off" spellcheck="false"
               style="font-family:monospace; flex:1;" />
        <button id="apiKeyToggle" class="secondary" type="button" style="width:44px; padding:10px 0; flex-shrink:0;" title="Show/hide key">ğŸ‘</button>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <button id="apiKeySave" type="button">Save &amp; activate</button>
        <button id="apiKeyClear" class="secondary" type="button">Clear saved key</button>
      </div>
      <div id="apiKeyStatus" style="font-size:12px; margin-top:6px; min-height:16px;"></div>
    </div>
  </details>
</div>

<!-- DEBUG -->
<div class="card">
  <h3 style="margin:0 0 8px;">Debug</h3>
  <div class="hint">Raw scan, parsed fields, and (on Submit) the final payload.</div>
  <label>Raw scan</label>
  <pre id="rawOut">(none yet)</pre>
  <label style="margin-top:10px;">Fields detected</label>
  <pre id="fieldsOut">(none yet)</pre>
  <label style="margin-top:10px;">Submit payload</label>
  <pre id="payloadOut">(submit to view payload)</pre>
</div>

<!-- ZXing lazy-loader (iOS / non-Chrome fallback) -->
<script>
let _zxingPromise = null;
function loadZXing() {
  if (_zxingPromise) return _zxingPromise;
  _zxingPromise = new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js';
    s.onload  = resolve;
    s.onerror = () => reject(new Error('Failed to load ZXing barcode library'));
    document.head.appendChild(s);
  });
  return _zxingPromise;
}
</script>

<script>
(function () {
  'use strict';

  // â”€â”€ CONFIG â€” key lives in localStorage, never in source code â”€
  const LS_KEY    = 'gmaps_api_key';
  const getApiKey = () => localStorage.getItem(LS_KEY) || '';

  // â”€â”€ Nationality â†’ ISO-2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const NAT_MAP = {
    'SA':'za','RSA':'za','ZA':'za','SOUTH AFRICA':'za','SOUTH AFRICAN':'za',
    'NAM':'na','NAMIBIA':'na','NAMIBIAN':'na',
    'ZWE':'zw','ZIMBABWE':'zw','ZIMBABWEAN':'zw',
    'MOZ':'mz','MOZAMBIQUE':'mz','MOZAMBICAN':'mz',
    'BWA':'bw','BOTSWANA':'bw','MOTSWANA':'bw',
    'ZMB':'zm','ZAMBIA':'zm','ZAMBIAN':'zm',
    'MWI':'mw','MALAWI':'mw','MALAWIAN':'mw',
    'SWZ':'sz','ESWATINI':'sz','SWAZILAND':'sz',
    'LSO':'ls','LESOTHO':'ls','BASOTHO':'ls',
    'GBR':'gb','UK':'gb','UNITED KINGDOM':'gb','BRITISH':'gb',
    'USA':'us','US':'us','UNITED STATES':'us','AMERICAN':'us',
    'IND':'in','INDIA':'in','INDIAN':'in',
    'CHN':'cn','CHINA':'cn','CHINESE':'cn',
    'PRT':'pt','PORTUGAL':'pt','PORTUGUESE':'pt',
  };
  const natToIso2 = raw => raw ? (NAT_MAP[raw.trim().toUpperCase()] || null) : null;

  // â”€â”€ Element refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = id => document.getElementById(id);

  const scanCapture  = $('scanCapture');
  const status       = $('status');
  const rawOut       = $('rawOut');
  const fieldsOut    = $('fieldsOut');
  const payloadOut   = $('payloadOut');
  const placesSearch = $('placesSearch');
  const placesStatus = $('placesStatus');

  // Camera overlay
  const scanOverlay  = $('scanOverlay');
  const cameraFeed   = $('cameraFeed');
  const scanFrame    = $('scanFrame');
  const scanMsg      = $('scanMsg');
  const torchBtn     = $('torchBtn');

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let buffer = '', flushTimer = null;
  let placesAC = null, placesSvc = null;

  // Camera
  let cameraStream   = null;
  let scanLoopHandle = null;   // rAF id or interval id
  let scanEngine     = null;   // 'native' | 'zxing'
  let nativeDet      = null;
  let scanCanvas     = null, scanCtx = null;
  let torchOn        = false;
  let torchTrack     = null;
  let lastResult     = null;
  let lastResultTime = 0;

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(msg, ok = true) {
    status.innerHTML = `<span class="${ok ? 'ok' : 'bad'}">${msg}</span>`;
  }
  function setPlacesStatus(msg, type = 'ok') {
    placesStatus.innerHTML = msg ? `<span class="${type}">${msg}</span>` : '';
  }
  function setScanMsg(msg, type = '') {
    scanMsg.textContent = msg;
    scanMsg.className = type === 'ok' ? 'ok-msg' : type === 'bad' ? 'bad-msg' : '';
  }

  // â”€â”€ Step navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStep(n) {
    $('step1').classList.toggle('hidden', n !== 1);
    $('step2').classList.toggle('hidden', n !== 2);
    $('pill1').classList.toggle('active', n === 1);
    $('pill2').classList.toggle('active', n === 2);
    if (n === 2) { scanCapture.blur(); applyCountryFromNationality(); }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function applyCountryFromNationality() {
    if (!placesAC) return;
    const raw  = $('nationality').value;
    const iso2 = natToIso2(raw);
    if (iso2) {
      placesAC.setComponentRestrictions({ country: iso2 });
      setPlacesStatus(`Address search restricted to <b>${iso2.toUpperCase()}</b> (from "${raw}")`, 'ok');
    } else {
      placesAC.setComponentRestrictions({});
      setPlacesStatus(raw ? `No country mapping for "${raw}" â€” searching globally` : 'No nationality scanned â€” searching globally', 'warn');
    }
  }

  // â”€â”€ Clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearAll() {
    buffer = ''; scanCapture.value = '';
    rawOut.textContent = '(none yet)';
    fieldsOut.textContent = '(none yet)';
    payloadOut.textContent = '(submit to view payload)';
    placesSearch.value = ''; setPlacesStatus('');
    ['surname','names','gender','idNumber','dob','citizenship','nationality','issueDate',
     'race','language','maritalStatus','addrCountry','streetNumber','streetName',
     'suburb','cityTown','province','postalCode'
    ].forEach(id => { const el = $(id); if (el) el.value = ''; });
    setStatus('Cleared.', true);
    setStep(1);
  }

  // â”€â”€ Barcode text â†’ form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function normalizeWS(s) {
    return s.replace(/\r/g,'\n').replace(/\t/g,'\n').replace(/[ ]{2,}/g,' ').trim();
  }
  function splitFields(s) {
    if (/\n/.test(s)) return s.split('\n').map(p => p.trim()).filter(Boolean);
    if (s.includes('|')) return s.split('|').map(p => p.trim()).filter(Boolean);
    return s.split(/\s*\|\s*|\s{2,}/).map(p => p.trim()).filter(Boolean);
  }
  function parseSaIdFields(parts) {
    const idx = parts.findIndex(p => /^\d{13}$/.test(p.replace(/\s/g,'')));
    const idNumber = idx >= 0 ? parts[idx].replace(/\s/g,'') : '';
    let surname = parts[0]||'', names = parts[1]||'', gender = '';
    let nationality = parts[3]||'', dobRaw = parts[5]||'';
    let citizenship = parts[7]||'', issueRaw = parts[8]||'';

    const isGender    = v => /^[MF]$/i.test((v||'').trim());
    const isDateWords = v => /^\d{2}\s+[A-Z]{3}\s+\d{4}$/i.test((v||'').trim());
    const parseDW     = v => {
      const m = (v||'').trim().toUpperCase().match(/^(\d{2})\s+([A-Z]{3})\s+(\d{4})$/);
      if (!m) return '';
      const MM = {JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',
                  JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'}[m[2]]||'';
      return MM ? `${m[3]}-${MM}-${m[1]}` : '';
    };

    if (isGender(parts[2])) gender = parts[2].toUpperCase();
    if (idx >= 0) {
      if ((!nationality||nationality.length>10)&&parts[idx-1]) nationality = parts[idx-1];
      if (!dobRaw     && parts[idx+1]) dobRaw      = parts[idx+1];
      if (!citizenship&& parts[idx+3]) citizenship = parts[idx+3];
      if (!issueRaw   && parts[idx+4]) issueRaw    = parts[idx+4];
      if (!gender) { const g = parts.find(isGender); if (g) gender = g.toUpperCase(); }
    }
    return {
      surname, names, gender, nationality, idNumber,
      dob:       isDateWords(dobRaw)   ? parseDW(dobRaw)   : '',
      citizenship,
      issueDate: isDateWords(issueRaw) ? parseDW(issueRaw) : '',
    };
  }

  function fillStep1(d) {
    if (d.surname)     $('surname').value     = d.surname;
    if (d.names)       $('names').value       = d.names;
    if (d.gender)      $('gender').value      = d.gender;
    if (d.nationality) $('nationality').value = d.nationality;
    if (d.idNumber)    $('idNumber').value    = d.idNumber;
    if (d.dob)         $('dob').value         = d.dob;
    if (d.citizenship) $('citizenship').value = d.citizenship;
    if (d.issueDate)   $('issueDate').value   = d.issueDate;
  }

  function parseAndApply(raw) {
    const n = normalizeWS(raw);
    rawOut.textContent = n || '(empty)';
    const parts = splitFields(n);
    fieldsOut.textContent = parts.map((p,i) => `[${i}] ${p}`).join('\n') || '(no fields)';
    const data = parseSaIdFields(parts);
    fillStep1(data);
    if (data.idNumber) setStatus('Scan captured â€” Step 1 autofilled âœ“', true);
    else               setStatus('Scan captured, but no 13-digit ID found. Check Debug.', false);
  }

  // â”€â”€ Keyboard wedge scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function scheduleFlush() {
    if (flushTimer) clearTimeout(flushTimer);
    flushTimer = setTimeout(() => {
      if (buffer.trim()) { parseAndApply(buffer); buffer = ''; scanCapture.value = ''; }
    }, 120);
  }
  scanCapture.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      const raw = (buffer + (scanCapture.value ? '\n'+scanCapture.value : '')).trim();
      if (raw) parseAndApply(raw);
      buffer = ''; scanCapture.value = ''; return;
    }
    scheduleFlush();
  });
  scanCapture.addEventListener('input', () => { buffer = scanCapture.value; scheduleFlush(); });

  // â”€â”€ Camera scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Determine best available PDF417 decoder
  async function pickEngine() {
    if ('BarcodeDetector' in window) {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('pdf417')) {
          nativeDet = new BarcodeDetector({ formats: ['pdf417'] });
          return 'native';
        }
      } catch(_) {}
    }
    // Fall back to ZXing (iOS Safari, Firefox, older Android)
    await loadZXing();
    return 'zxing';
  }

  function flashSuccess() {
    const div = document.createElement('div');
    div.className = 'flash-layer';
    scanFrame.appendChild(div);
    setTimeout(() => div.remove(), 700);
  }

  function onBarcode(text) {
    const now = Date.now();
    if (text === lastResult && now - lastResultTime < 3000) return; // debounce repeats
    lastResult = text; lastResultTime = now;
    flashSuccess();
    setScanMsg('Barcode detected âœ“', 'ok');
    setTimeout(() => {
      stopCamera();
      parseAndApply(text);
      setStatus('Camera scan successful â€” Step 1 autofilled âœ“', true);
    }, 650);
  }

  // Native BarcodeDetector â€” runs on requestAnimationFrame
  async function nativeLoop() {
    if (!cameraStream) return;
    if (cameraFeed.readyState < 2) { scanLoopHandle = requestAnimationFrame(nativeLoop); return; }
    try {
      const results = await nativeDet.detect(cameraFeed);
      if (results.length) { onBarcode(results[0].rawValue); return; }
    } catch(_) {}
    scanLoopHandle = requestAnimationFrame(nativeLoop);
  }

  // ZXing â€” runs on setInterval, decodes canvas frames
  function startZXingLoop() {
    if (!scanCanvas) { scanCanvas = document.createElement('canvas'); scanCtx = scanCanvas.getContext('2d'); }
    const ZX = window.ZXing;
    const hints = new Map([
      [ZX.DecodeHintType.POSSIBLE_FORMATS, [ZX.BarcodeFormat.PDF_417]],
      [ZX.DecodeHintType.TRY_HARDER, true],
    ]);
    const reader = new ZX.BrowserPDF417Reader(hints);

    scanLoopHandle = setInterval(() => {
      if (!cameraStream || cameraFeed.readyState < 2 || cameraFeed.paused) return;
      const vw = cameraFeed.videoWidth, vh = cameraFeed.videoHeight;
      if (!vw || !vh) return;
      scanCanvas.width = vw; scanCanvas.height = vh;
      scanCtx.drawImage(cameraFeed, 0, 0, vw, vh);
      const imgData  = scanCtx.getImageData(0, 0, vw, vh);
      const lum      = new ZX.RGBLuminanceSource(imgData.data, vw, vh);
      const bmp      = new ZX.BinaryBitmap(new ZX.HybridBinarizer(lum));
      try {
        const res = reader.decode(bmp, hints);
        if (res && res.getText()) onBarcode(res.getText());
      } catch(_) { /* NotFoundException = no barcode in frame, normal */ }
    }, 250);
  }

  async function startCamera() {
    $('cameraBtn').disabled = true;
    setScanMsg('Initialisingâ€¦');
    scanOverlay.classList.remove('hidden');

    try {
      setScanMsg('Loading decoderâ€¦');
      scanEngine = await pickEngine();
      setScanMsg(`Decoder ready (${scanEngine === 'native' ? 'BarcodeDetector' : 'ZXing'}). Requesting cameraâ€¦`);

      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false,
      });

      cameraFeed.srcObject = cameraStream;
      await cameraFeed.play();

      // Torch
      torchTrack = cameraStream.getVideoTracks()[0];
      const caps = torchTrack?.getCapabilities?.() || {};
      torchBtn.style.display = caps.torch ? '' : 'none';

      setScanMsg('Point barcode at the frameâ€¦');

      if (scanEngine === 'native') {
        scanLoopHandle = requestAnimationFrame(nativeLoop);
      } else {
        startZXingLoop();
      }

    } catch (err) {
      stopCamera();
      let msg;
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        if (location.protocol === 'file:') {
          msg = 'Camera blocked: browsers do not allow camera access on file:// URLs. ' +
                'Serve the page via a local server (e.g. "npx serve ." or "python -m http.server") ' +
                'and open http://localhost:&lt;port&gt; instead.';
        } else {
          msg = 'Camera permission denied. Please allow camera access in your browser settings and try again.';
        }
      } else if (err.name === 'NotFoundError') {
        msg = 'No camera found on this device.';
      } else if (err.name === 'NotReadableError') {
        msg = 'Camera is busy â€” close other apps using it and try again.';
      } else if (err.name === 'SecurityError') {
        msg = 'Camera blocked by browser security policy. Page must be served over HTTPS or localhost.';
      } else {
        msg = `Camera error (${err.name}): ${err.message}`;
      }
      setStatus(msg, false);
      $('cameraBtn').disabled = false;
    }
  }

  function stopCamera() {
    if (scanEngine === 'native' && scanLoopHandle) cancelAnimationFrame(scanLoopHandle);
    else if (scanLoopHandle) clearInterval(scanLoopHandle);
    scanLoopHandle = null;

    if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
    cameraFeed.srcObject = null;

    torchOn = false; torchBtn.classList.remove('lit');
    scanOverlay.classList.add('hidden');
    $('cameraBtn').disabled = false;
  }

  async function toggleTorch() {
    if (!torchTrack) return;
    torchOn = !torchOn;
    try {
      await torchTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      torchBtn.classList.toggle('lit', torchOn);
    } catch(_) { torchOn = !torchOn; }
  }

  $('cameraBtn').addEventListener('click', startCamera);
  $('closeScanBtn').addEventListener('click', stopCamera);
  torchBtn.addEventListener('click', toggleTorch);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && !scanOverlay.classList.contains('hidden')) stopCamera();
  });

  // â”€â”€ Google Places â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function parseAC(ac) {
    const get = t => { const c = (ac||[]).find(x => x.types?.includes(t)); return c ? c.long_name : ''; };
    return {
      streetNumber: get('street_number'),
      streetName:   get('route'),
      suburb:       get('sublocality')||get('sublocality_level_1')||get('neighborhood')||get('administrative_area_level_3')||'',
      cityTown:     get('locality')||get('postal_town')||get('administrative_area_level_2')||'',
      province:     get('administrative_area_level_1'),
      addrCountry:  get('country'),
      postalCode:   get('postal_code'),
    };
  }

  function fillAddress(d) {
    Object.entries({addrCountry:'addrCountry',streetNumber:'streetNumber',streetName:'streetName',
                    suburb:'suburb',cityTown:'cityTown',province:'province',postalCode:'postalCode'})
      .forEach(([k,id]) => { if (d[k]) $(id).value = d[k]; });
  }

  function loadGoogle(apiKey) {
    return new Promise((resolve, reject) => {
      if (!apiKey) {
        setPlacesStatus('Enter your Google Maps API key in Settings to enable address autofill', 'warn');
        resolve(false); return;
      }
      // If Maps already loaded with the same key, reuse it
      if (window.google?.maps) { resolve(true); return; }
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places`;
      s.async = true; s.defer = true;
      s.onload  = () => resolve(true);
      s.onerror = () => reject(new Error('Google Maps failed to load â€” check your API key'));
      document.head.appendChild(s);
    });
  }

  async function initPlaces(apiKey) {
    if (!await loadGoogle(apiKey)) return;
    placesAC  = new google.maps.places.Autocomplete(placesSearch, {
      fields: ['place_id','name','formatted_address','address_components']
    });
    placesSvc = new google.maps.places.PlacesService(document.createElement('div'));
    placesAC.addListener('place_changed', () => {
      const p = placesAC.getPlace(); if (!p) return;
      placesSearch.value = '';
      if (p.address_components?.length) { fillAddress(parseAC(p.address_components)); setPlacesStatus('Address autofilled âœ“', 'ok'); return; }
      if (!p.place_id) return;
      placesSvc.getDetails({ placeId: p.place_id, fields: ['address_components'] }, (d, st) => {
        if (st !== google.maps.places.PlacesServiceStatus.OK || !d) { setPlacesStatus(`Place details failed: ${st}`, 'bad'); return; }
        fillAddress(parseAC(d.address_components)); setPlacesStatus('Address autofilled âœ“', 'ok');
      });
    });
    setPlacesStatus('Address search ready', 'ok');
  }

  // â”€â”€ Button wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('startBtn').addEventListener('click', () => {
    scanCapture.focus({ preventScroll: true });
    setStatus('Ready â€” scan with your external barcode scanner nowâ€¦', true);
  });
  $('clearBtn').addEventListener('click', clearAll);
  $('nextStepBtn').addEventListener('click', () => setStep(2));
  $('backBtn').addEventListener('click', () => setStep(1));
  $('submitBtn').addEventListener('click', () => {
    const p = {
      surname:$('surname').value.trim()||null, names:$('names').value.trim()||null,
      gender:$('gender').value||null, idNumber:$('idNumber').value.trim()||null,
      dob:$('dob').value.trim()||null, citizenship:$('citizenship').value.trim()||null,
      nationality:$('nationality').value.trim()||null, issueDate:$('issueDate').value.trim()||null,
      race:$('race').value||null, language:$('language').value||null,
      maritalStatus:$('maritalStatus').value||null,
      country:$('addrCountry').value.trim()||null, streetNumber:$('streetNumber').value.trim()||null,
      streetName:$('streetName').value.trim()||null, suburb:$('suburb').value.trim()||null,
      cityTown:$('cityTown').value.trim()||null, province:$('province').value.trim()||null,
      postalCode:$('postalCode').value.trim()||null,
    };
    payloadOut.textContent = JSON.stringify(p, null, 2);
    setStatus('Submitted â€” payload in Debug panel', true);
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  });

  // â”€â”€ Settings: API key management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateApiKeyBadge() {
    const badge = $('apiKeyBadge');
    if (getApiKey()) {
      badge.textContent = 'â— Key saved';
      badge.style.background = '#d4edda';
      badge.style.color = '#155724';
    } else {
      badge.textContent = 'â—‹ No key';
      badge.style.background = '#fff3cd';
      badge.style.color = '#856404';
    }
  }

  function setApiKeyStatus(msg, ok = true) {
    $('apiKeyStatus').innerHTML = `<span class="${ok ? 'ok' : 'bad'}">${msg}</span>`;
  }

  // Populate input with masked existing key on load
  function loadApiKeyIntoInput() {
    const k = getApiKey();
    $('apiKeyInput').value = k || '';
  }

  $('apiKeyToggle').addEventListener('click', () => {
    const inp = $('apiKeyInput');
    const isHidden = inp.type === 'password';
    inp.type = isHidden ? 'text' : 'password';
    $('apiKeyToggle').textContent = isHidden ? 'ğŸ™ˆ' : 'ğŸ‘';
  });

  $('apiKeySave').addEventListener('click', async () => {
    const key = $('apiKeyInput').value.trim();
    if (!key) { setApiKeyStatus('Please enter an API key first.', false); return; }

    localStorage.setItem(LS_KEY, key);
    updateApiKeyBadge();
    setApiKeyStatus('Key saved!', true);

    // If Maps not yet loaded, init now; if already loaded, just re-attach autocomplete
    if (!window.google?.maps) {
      setPlacesStatus('Loading Google Mapsâ€¦', 'ok');
      try {
        await initPlaces(key);
        setApiKeyStatus('Key saved & Google Maps activated âœ“', true);
        setPlacesStatus('Address search ready âœ“', 'ok');
      } catch(e) {
        setApiKeyStatus(`Error: ${e.message}`, false);
        setPlacesStatus(`Google Maps error: ${e.message}`, 'bad');
      }
    } else {
      // Maps SDK already loaded â€” just re-attach the autocomplete widget
      try {
        await initPlaces(key);
        setApiKeyStatus('Key saved âœ“ (Maps already loaded)', true);
      } catch(e) {
        setApiKeyStatus(`Error: ${e.message}`, false);
      }
    }
  });

  $('apiKeyClear').addEventListener('click', () => {
    localStorage.removeItem(LS_KEY);
    $('apiKeyInput').value = '';
    updateApiKeyBadge();
    setApiKeyStatus('Key cleared. Address autofill disabled.', true);
    setPlacesStatus('Enter your Google Maps API key in Settings to enable address autofill', 'warn');
    placesAC = null; placesSvc = null;
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('load', () => {
    loadApiKeyIntoInput();
    updateApiKeyBadge();
    // Auto-open settings if no key saved yet
    if (!getApiKey()) $('settingsDetails').open = true;
    if (location.protocol === 'file:') {
      $('cameraBtn').disabled = true;
      $('cameraBtn').title = 'Camera is blocked on file:// URLs â€” serve via localhost instead';
      setStatus(
        'âš  Camera unavailable on file:// URLs. ' +
        'Run a local server (e.g. <code>npx serve .</code> or <code>python -m http.server</code>) ' +
        'and open <b>http://localhost:&lt;port&gt;</b> to enable camera scanning. ' +
        'The keyboard scanner still works here.',
        false
      );
    } else if (!navigator.mediaDevices?.getUserMedia) {
      $('cameraBtn').disabled = true;
      $('cameraBtn').title = 'Camera API requires HTTPS and a compatible browser';
    }
    if (location.protocol !== 'file:') {
      setStatus('Tap "Scan with Camera" to scan, or use a keyboard barcode scanner.', true);
    }
    initPlaces(getApiKey()).catch(e => setPlacesStatus(`Google Maps error: ${e.message}`, 'bad'));
  });

})();
</script>

</body>
</html>